#!/bin/bash

# Before running, make sure to satisfy all the deps via:
# aptitude install build-essential devscripts debhelper gnupg

dpkg-query -W -f='${Status} ${PackageSpec} ${Version}\n' \
	build-essential devscripts debhelper gnupg | \
	grep -v 'install ok installed' && exit 1

KEY_ID=${KEY_ID:-${1:?set \$KEY_ID in your environment or pass PGP id on the command-line}}

set -ex

export SERIES="precise"
export DEBUILD_TGZ_CHECK="no"

MAIN_VERSION=2.1.8
GITHASH=`git log --pretty=format:'%h' -n 1`
EPOCHTIME=`date +%s`

for dist in $SERIES ; do
    RELEASE="${MAIN_VERSION}-0ubuntu3~${EPOCHTIME}~${GITHASH}~${dist}"
    dch -M -D $dist -u critical -v ${RELEASE} "Autogenerated build"

    debuild -S -k${KEY_ID}

    (cd .. && dput ppa:metacloud-private/build spine_${RELEASE}_source.changes)
done
